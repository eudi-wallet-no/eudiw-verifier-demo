package no.idporten.eudiw.demo.verifier.openid4vp;

import no.idporten.eudiw.demo.verifier.VerificationException;
import no.idporten.eudiw.demo.verifier.config.ConfigProvider;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Nested;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;

import static org.junit.jupiter.api.Assertions.*;

@DisplayName("When processing OpenID4VP responses")
@SpringBootTest(classes = {OpenID4VPResponseService.class, ConfigProvider.class})
class OpenID4VPResponseServiceTest {

    @MockitoBean
    private VerificationTransactionService verificationTransactionService;

    @MockitoBean
    private ConfigProvider configProvider;

    @InjectMocks
    private OpenID4VPResponseService openID4VPResponseService;

    @DisplayName("with vp-token of type sd-jwt")
    @Nested
    class SDJwt {


        @DisplayName("from Hellas throws expected exception due to invalid signature because of expired certificate")
        @Test
        void retrieveClaimsFromSDJwtCredential_Hellas() {
            String vpToken = "eyJhbGciOiAiRVMyNTYiLCAidHlwIjogImRjK3NkLWp3dCIsICJ4NWMiOiBbIk1JSUNpakNDQWpDZ0F3SUJBZ0lVRmlNQ1dmcXBQRXJGMVdrNlhVRVdkWGxFc284d0NnWUlLb1pJemowRUF3SXdQVEVlTUJ3R0ExVUVBd3dWVUVsRUlFbHpjM1ZsY2lCRFFTQXRJRWRTSURBeE1RNHdEQVlEVlFRS0RBVkhVazVGVkRFTE1Ba0dBMVVFQmhNQ1IxSXdIaGNOTWpVeE1UQXpNVE16TVRVMFdoY05Nall4TWpBNE1UTXpNVFUwV2pCSE1TZ3dKZ1lEVlFRRERCOXpibVl0TnpRNE5qUXViMnN0YTI1dkxtZHlibVYwWTJ4dmRXUXVibVYwTVE0d0RBWURWUVFLREFWSFVrNUZWREVMTUFrR0ExVUVCaE1DUjFJd1dUQVRCZ2NxaGtqT1BRSUJCZ2dxaGtqT1BRTUJCd05DQUFUbmVvSjZhdTl2dHRBRWtaVzhYWGlKOWxlM1Z3YkZaQU50Uk1nVUFoSEdUR3pFL3M0UldTWU5tNEVTZFhEQVYrS1hsb2FwL3l0N0dORGdSc3J6SWdYVm80SUJBakNCL3pBSkJnTlZIUk1FQWpBQU1CMEdBMVVkRGdRV0JCUTVUaDkvSTI5TzdGNmRGa3ppR3lWRnkvOEhRekI0QmdOVkhTTUVjVEJ2Z0JROWZWcTlaaWZCcmRJVjFnTDg5VU14RkMrSHk2RkJwRDh3UFRFZU1Cd0dBMVVFQXd3VlVFbEVJRWx6YzNWbGNpQkRRU0F0SUVkU0lEQXhNUTR3REFZRFZRUUtEQVZIVWs1RlZERUxNQWtHQTFVRUJoTUNSMUtDRkFSNHVJc1ZXUHIrdTRaK3VCQzZsblAzTGlLRU1CVUdBMVVkSlFFQi93UUxNQWtHQnlpQmpGMEZBUUl3TWdZRFZSMGZCQ3N3S1RBbm9DV2dJNFloYUhSMGNEb3ZMemd6TGpJeE1pNDNNaTR4TVRRNk9EQTRNaTlqY213dWNHVnRNQTRHQTFVZER3RUIvd1FFQXdJSGdEQUtCZ2dxaGtqT1BRUURBZ05JQURCRkFpQWFsbnhVa25mWGd1N2JEbjVBQS9veWZCaGFNcGZwdmdlWkVnc002Q2hrSWdJaEFJSUdueVU4NTFSUVJxQ0trRC9Dc3RDY2dad1U4R0JDQ1plbzNSR2tySVNkIl19.eyJfc2QiOiBbIkFCbjhpV0xEMVdudnFoQk9KZTllVTNQMk92YXgwREJtWEJ2RmNWcDBpU3ciLCAiRDc3ZU45dWZoMFl4YjRaMEN1NFNuQ1kxdDBZN0RPSDd6QWhmUzcyVGhnVSIsICJJa2I4ZzBiX2VveFFfUXo4dEFNNExKZnhIb3JGMzlSejV2U1pBMmcxLU5ZIiwgIktGN2o0QS1ULWZuQlF6YlVvRWhjYUROM1J2Y050bUR1WU5yREQxdHpUVm8iLCAiWUUwaHBUc1JSRE5VQnZ0X01vakxmQ25MQU9Wbi1fWFpGRnRpYnpyeDJ5ayIsICJaWEszOGdpVHViaHhZOEFmMFd6aUtWc3lOUDB5TkJaT3FPQnk5WTJld0N3IiwgIl9pa0xfTU8xVkVJRUgwN3dxX3lZT3VmWTlPclRLWVdiTzR4QjhrSVlSVXMiLCAiYktESWF3SHBJeS0ySkhvejJ4bFZGRGVIOVkxOUVhRlFnQ1gxdW4tQ0VoYyIsICJsMldIcVBETk9QUjAyRUwyWFdFOFBlOU51YXdSTWcxMjgwbXNyMUJ3ZkU0Il0sICJpc3MiOiAiaHR0cHM6Ly9zbmYtNzQ4NjQub2sta25vLmdybmV0Y2xvdWQubmV0OjU2MDAiLCAiaWF0IjogMTc2NTQxMTIwMCwgImV4cCI6IDE3NzMxODcyMDAsICJ2Y3QiOiAidXJuOmV1ZGk6cGlkOjEiLCAiX3NkX2FsZyI6ICJzaGEtMjU2IiwgImNuZiI6IHsiandrIjogeyJrdHkiOiAiRUMiLCAiY3J2IjogIlAtMjU2IiwgIngiOiAiVk9rdEpoSnV3T0dWY1Npb25SZVZ5UjdUbC1Sa183aExuVWJNelBHd3BRVSIsICJ5IjogIlFNY0NqcHZkM2c0bVRnWWp4UTk2amxpekJGT2RKdElCV2FublVPckRJZ1kifX19.8Z-DemK0uUvpXgXiiIsQ3AU9rt2OYVFqEeYUPe2IY5iuNZUo_LSP65-gSwu2bDa-2Wa2PwT2kQAGu_wSCk1e8A~WyI0Vm00cnBSUnBnbURiajJ1SWhqV3NBIiwgImdpdmVuX25hbWUiLCAiTWFyaW9zIl0~WyJrNjVEUUFLSWJXN192R0wxUVBqMHdRIiwgImZhbWlseV9uYW1lIiwgIk1lbmV4ZXMiXQ~WyItbVRzWURfQU16R0hHYVBBQUxrVzdnIiwgImJpcnRoZGF0ZSIsICIyMDI1LTEyLTExIl0~WyJ5dy1ZMVlISjktREhHVGJVbmpRZS13IiwgIm5hdGlvbmFsaXRpZXMiLCBbeyIuLi4iOiAicE0tWGV3WHVXdm9LaUZhZG5TUTJwRTJ1OUF1cXE0ZDI4dG9HZWhpUjE4cyJ9XV0~WyJWM0dYdkx2SDJGdENpMkNzZzFwbWNRIiwgInBsYWNlX29mX2JpcnRoIiwgeyJfc2QiOiBbIlNoWUZuRTBYZUFtcGIxSnpMS3lIRHVMSXJfTXM2WnFxTENKcDBVNDlCenMiLCAiYkphaUROcTNTbEZjd1dabXpMTG9vdUw2OVRlaDlBYjN4VUtaVXJTdkdUayIsICJtd2ktNF9yWXYyeG9VRlhOVGt2WXIybExOajZMdEVNdWhPWVNNanBzc3RJIl19XQ~WyJ6VHVqWUFoSE5ibVk2X1lXSEoyV0JnIiwgImNvdW50cnkiLCAiR3JlZWNlIl0~WyJnNXVZRFJDblVfaWU3MzVEbk9aQ0d3IiwgInJlZ2lvbiIsICJBdHRpY2EiXQ~WyJGQlo3YnkxbW9nS1ktMFhSdk9RTHBRIiwgImxvY2FsaXR5IiwgIkF0aGVucyJd~eyJ0eXAiOiJrYitqd3QiLCJhbGciOiJFUzI1NiJ9.eyJzZF9oYXNoIjoiMmh5U1V5SU9hX2hhaFFHMUgyb2hEXy1LNVFqMU5Sb0dIb0ZRVHpNOV9zayIsImF1ZCI6Ing1MDlfc2FuX2RuczpkZW1vLWJydWtlcnN0ZWQudGVzdC5laWRhczJzYW5ka2Fzc2UubmV0Iiwibm9uY2UiOiJiNmM4NTk1Mi0wNDYwLTQzMWYtOWRhNS1lMzUxZjA4NGRkN2IiLCJpYXQiOjE3NjU0NTk4MDl9.8ZTzLWKCluaqv1VBUCISsje3i-cHgI37S31JbRPG3MnH_oFRmSanV5EJ6BlD9ZDka8lI2et2lcQkg4z2uQ9dZw";
            VerificationException e = assertThrows(VerificationException.class, () -> openID4VPResponseService.retrieveClaimsFromSDJwtCredential(vpToken));
            assertNotNull(e.getMessage());
            assertTrue(e.getMessage().contains("Signature verified: false"), e.getMessage());
            assertTrue(e.getMessage().contains("disclosures verified: true"), e.getMessage());
        }

        // vp-token invalid?
        @DisplayName("from Italia throws expected exception due to Invalid selective disclosure")
        @Test
        void retrieveClaimsFromSDJwtCredential_Italia() {
            final String vpToken = "eyJhbGciOiAiRVMyNTYiLCAidHlwIjogImRjK3NkLWp3dCIsICJ4NWMiOiBbIk1JSUM0RENDQW9XZ0F3SUJBZ0lVVkRGWEV1eWMzRkI0RTdwY1NBbUpkckRxZFRZd0NnWUlLb1pJemowRUF3SXdYREVlTUJ3R0ExVUVBd3dWVUVsRUlFbHpjM1ZsY2lCRFFTQXRJRkJVSURBeU1TMHdLd1lEVlFRS0RDUkZWVVJKSUZkaGJHeGxkQ0JTWldabGNtVnVZMlVnU1cxd2JHVnRaVzUwWVhScGIyNHhDekFKQmdOVkJBWVRBbEJVTUI0WERUSTFNRFF4TURFME16WTFPVm9YRFRJMk1EY3dOREUwTXpZMU9Gb3dVakVVTUJJR0ExVUVBd3dMVUVsRUlFUlRJQzBnTURFeExUQXJCZ05WQkFvTUpFVlZSRWtnVjJGc2JHVjBJRkpsWm1WeVpXNWpaU0JKYlhCc1pXMWxiblJoZEdsdmJqRUxNQWtHQTFVRUJoTUNVRlF3V1RBVEJnY3Foa2pPUFFJQkJnZ3Foa2pPUFFNQkJ3TkNBQVRJUXVZNUZ3MWxlYkZ3aEFYaXNJYm5tVDBIaG1aQzMwYVQzMUptWEFBaVVXZjNBckhrTG1wSlR4R0RVa0tvM2NydU5JdnhFYU5JTk02aDJYa1E0OHFwbzRJQkxUQ0NBU2t3SHdZRFZSMGpCQmd3Rm9BVS9GcTZ4Mk1oMEZUS1Q1UjVmZVdxMDhTK21KRXdHd1lEVlIwUkJCUXdFb0lRYVhOemRXVnlMbVYxWkdsM0xtUmxkakFXQmdOVkhTVUJBZjhFRERBS0JnZ3JnUUlDQUFBQkFqQkRCZ05WSFI4RVBEQTZNRGlnTnFBMGhqSm9kSFJ3Y3pvdkwzQnlaWEJ5YjJRdWNHdHBMbVYxWkdsM0xtUmxkaTlqY213dmNHbGtYME5CWDFCVVh6QXlMbU55YkRBZEJnTlZIUTRFRmdRVXBUV0ZmQVl1K1JSZkJ1djk2RUxBdzhlaFIyY3dEZ1lEVlIwUEFRSC9CQVFEQWdlQU1GMEdBMVVkRWdSV01GU0dVbWgwZEhCek9pOHZaMmwwYUhWaUxtTnZiUzlsZFMxa2FXZHBkR0ZzTFdsa1pXNTBhWFI1TFhkaGJHeGxkQzloY21Ob2FYUmxZM1IxY21VdFlXNWtMWEpsWm1WeVpXNWpaUzFtY21GdFpYZHZjbXN3Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQUpOUy9ZdTZEcEM5VWlYTVdDUnQ4dG1QNFV3VnRQcEdXYnhjSWF3OFVVQ0tBaUVBczJkTUJ4cDAvcy90SC9tTWFWQSt0MWFtVFdLUDJBMzdVUDlzN1dmYVRpRT0iXX0.eyJfc2QiOiBbIjRUeENtRGFWZTFtLUdGS0V3Z3A0ZDBROGV1NWJWaWUyYmRuTEo5X0pQWDgiLCAiNGh6c3F2TFZMSUxxUDN4NWhsRHJjcEQxU2pCZUlNcF93QkQ2T2lFQUIxYyIsICI1azVKVzZVYUNuRGpVSjdXWU93T1dsVHRjSFlvRGJtbURHTDBBZjBEYlJrIiwgIjZwaXFFa1pkZWtjOHkwSnZGRTA1ZEVUSGdxcVpPU1RnVHBrZVI5bEFRWTgiLCAiVkdEVURkNi10bmFWYU9LS29CYnIyWVJIUGQzNjVGdmZJQkJpcnR2bzdXSSIsICJWaFF2NXIwbU9vTHVsRjFoMndoWkdkMFg5OWhoaHNJeTJzelZicW5yUjZjIiwgInJhLWY0WGd4OXdxRDF6R09Pc0tlTGt5RzJDTnVHU2FsZzlGaTNuek9EQjAiLCAic19nMS1Ha3Vyd2xuSWxGVWZlNVJXWGVCSmVNbEZFOFkzYlk3YUpsU29uQSIsICJ4dVhXajJNclQ2djZNVTJJMWpjX3ZkVXphYjlhRDh5YzRnNmtHQUR2eDRRIl0sICJpc3MiOiAiaHR0cHM6Ly9iYWNrZW5kLmV1ZGl3LmFydGUucHJvamouZXUiLCAiaWF0IjogMTc2NTQxMTIwMCwgImV4cCI6IDE3NzMxODcyMDAsICJ2Y3QiOiAidXJuOmV1ZGk6cGlkOjEiLCAic3RhdHVzIjogeyJpZGVudGlmaWVyX2xpc3QiOiB7ImlkIjogIjYwNzMiLCAidXJpIjogImh0dHBzOi8vYmFja2VuZC5ldWRpdy5hcnRlLnByb2pqLmV1L2lkZW50aWZpZXJfbGlzdC9GQy91cm46ZXVkaTpwaWQ6MS8xNmQ0ZDg4Zi1lYWU2LTQzYjctOWQwMy02MDE4OTY1Mzk2YWEifSwgInN0YXR1c19saXN0IjogeyJpZHgiOiA2MDczLCAidXJpIjogImh0dHBzOi8vYmFja2VuZC5ldWRpdy5hcnRlLnByb2pqLmV1L3Rva2VuX3N0YXR1c19saXN0L0ZDL3VybjpldWRpOnBpZDoxLzE2ZDRkODhmLWVhZTYtNDNiNy05ZDAzLTYwMTg5NjUzOTZhYSJ9fSwgIl9zZF9hbGciOiAic2hhLTI1NiIsICJjbmYiOiB7Imp3ayI6IHsia3R5IjogIkVDIiwgImNydiI6ICJQLTI1NiIsICJ4IjogInBzdXpkOHNqZklqTHVUYTRiNTktanpZT3BwbUE2US1zMnRPbmgwek9OT1UiLCAieSI6ICJWVVhId2pVR0FhTE91QWpzZC02bGlLTjFwVkE5X1E2RHo2Ri1nbDJfS05RIn19fQ.FXz_WcDDyjycFtkGRnIrNuQtg-0AB6GRqq7FAdFi1San1XJaOPu4XdrXeDleZ7TMGHrYW5ErydXv-_1Z5bjgZA~WyJUNVhRcXktZkdmS1Y5VnNyRVI4RXNBIiwgIlB0Il0~WyJTRS1sS3pENlEwOGF2TVVmN2lON1dnIiwgImNvdW50cnkiLCAiUHQiXQ~WyJ6S2FQeDlJQ0RXNDFWUzdEbFcwam9RIiwgImdpdmVuX25hbWUiLCAiQW5hIl0~WyJ6ZklYblJsMHNKYkVXLWZFQ2JOX1pBIiwgImZhbWlseV9uYW1lIiwgIkdyYWNhIl0~WyJ5cE9IaDVrb19FWExURU9YX2VIN0pBIiwgInBsYWNlX29mX2JpcnRoIiwgeyJfc2QiOiBbIjlTbkJSQ1lFbWNYQlNBZnVQUWZwdWw5MjhoQ1NoRlFJX1U3Tm1zbW51eTAiLCAiUFdyWC13alplTzFMYUw5LTU5cU1NU0RxWE9tRHJjLUZ4bkV2TVFzeEQ5ayIsICJiVDNMNkl3QUtqOHR5TG1vRXFTbFpWa3UtazZmTzM2dlBMcm5iNkxNMEVrIl19XQ~WyJjbXZIdF93UjMwQ2RVNzRORzlQVHR3IiwgIm5hdGlvbmFsaXRpZXMiLCBbeyIuLi4iOiAiLWoxdG55YmwybDBuR195YlpIdEFsM3ZjdURTWF9aLUZfLW5qWWxhRzZDYyJ9XV0~WyJTVllQVGVPRksyT3FtWVRGVHJ0ejVBIiwgInJlZ2lvbiIsICJMeCJd~WyJMSzdzTjktUFl3QWZ4T1dMVWtnbjV3IiwgImxvY2FsaXR5IiwgIkx4Il0~WyJZcmRfdUtoMVdyR1N0RFF0dlNaVXBnIiwgImJpcnRoZGF0ZSIsICIxOTg0LTEyLTExIl0~eyJhbGciOiJFUzI1NiIsInR5cCI6ImtiK2p3dCJ9.eyJub25jZSI6IjVlZjg3MWY5LTk1MjEtNDMxNC1iNDczLTYwMDAzZDUwZWFjNiIsInNkX2hhc2giOiJiVlZIWjQtWjJDajNTZmlQYnJoU3FidkZmV0p4cnhvRkxNVGdoanFob3VVIiwiaWF0IjoxNzY1NDU3MDA2LCJhdWQiOiJ4NTA5X3Nhbl9kbnM6ZGVtby1icnVrZXJzdGVkLnRlc3QuZWlkYXMyc2FuZGthc3NlLm5ldCJ9.TY7geWo4WL4L-ASwM0gTS22B2hb_YMjRgzbiOTWNfHt3Te6iFxSnPn1r-Cs8gF322kLc332hmsXGPw67ONgYzg";
            Exception e = assertThrows(Exception.class, () -> openID4VPResponseService.retrieveClaimsFromSDJwtCredential(vpToken));
            assertEquals("Invalid selective disclosure", e.getMessage());
        }
    }
}